<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibez - Real-Time Party & Events Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
        }
        
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .gradient-purple-pink {
            background-image: linear-gradient(to right, #a855f7, #ec4899);
        }
        
        .gradient-teal-blue {
            background-image: linear-gradient(to right, #2dd4bf, #3b82f6);
        }
        
        .gradient-orange-yellow {
            background-image: linear-gradient(to right, #fb923c, #facc15);
        }
        
        .animate-fade-in-down {
            animation: fadeInDown 1s ease-out;
        }
        
        .animate-fade-in-up {
            animation: fadeInUp 1s ease-out;
        }
        
        .hidden {
            display: none;
        }
        
        .tab-button.active {
            border-bottom: 3px solid #a855f7;
            color: #ec4899;
        }
        
        #map-container {
            width: 100%;
            height: 600px;
            border-radius: 0.5rem;
            z-index: 1;
        }
        
        .video-thumbnail {
            aspect-ratio: 16/9;
            object-fit: cover;
        }
        
        .skeleton-video {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #a855f7;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Real-time indicators */
        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #ef4444;
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 1.5s infinite;
        }
        
        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #10b981;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .tab-button {
                padding: 12px 16px;
                font-size: 14px;
                flex: 1;
                text-align: center;
            }
            
            #map-container {
                height: 400px;
            }
            
            #filters-sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                width: 100%;
                border-radius: 20px 20px 0 0;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }
            
            #filters-sidebar.open {
                transform: translateY(0);
            }
            
            .mobile-bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #1f2937;
                padding: 12px;
                display: flex;
                justify-content: space-around;
                z-index: 40;
            }
        }
        
        /* Touch-friendly buttons */
        .tab-button, .auth-button {
            min-height: 44px;
        }
        
        /* Prevent zoom on input focus */
        @media (max-width: 768px) {
            input, select, textarea {
                font-size: 16px;
            }
        }
        
        /* Leaflet map customizations */
        .leaflet-container {
            background: #1f2937;
        }
        
        .leaflet-popup-content-wrapper {
            background: #374151;
            color: #f9fafb;
            border-radius: 8px;
        }
        
        .leaflet-popup-tip {
            background: #374151;
        }
        
        .leaflet-control-zoom a {
            background: #374151;
            color: #f9fafb;
            border: none;
        }
        
        .leaflet-control-zoom a:hover {
            background: #4b5563;
        }
        
        .party-marker {
            background: #ec4899;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 0 10px rgba(236, 72, 153, 0.7);
        }
        
        .party-marker.high-rated {
            background: #facc15;
            box-shadow: 0 0 10px rgba(250, 204, 21, 0.7);
        }
        
        .party-marker.top-rated {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.7);
        }
        
        .party-marker.user-generated {
            background: #3b82f6;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
            border: 3px dashed white;
        }
        
        .party-marker.filtered-out {
            opacity: 0.3;
            transform: scale(0.8);
        }
        
        .event-marker {
            background: #8b5cf6;
            border: 3px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .event-marker i {
            color: white;
            font-size: 12px;
        }
        
        /* Map and filters layout */
        .map-filters-container {
            display: flex;
            gap: 1rem;
            position: relative;
        }
        
        #filters-sidebar {
            background: #1f2937;
            border-radius: 0.5rem;
            padding: 1.5rem;
            width: 280px;
            flex-shrink: 0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }
        
        #map-content-container {
            flex: 1;
            position: relative;
        }
        
        @media (max-width: 1024px) {
            .map-filters-container {
                flex-direction: column;
            }
            
            #filters-sidebar {
                width: 100%;
            }
        }
        
        /* Real-time updates */
        .new-content-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ec4899;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            animation: pulse 2s infinite;
        }
        
        /* Chat styles */
        .chat-message {
            max-width: 70%;
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 18px;
            position: relative;
            animation: fadeInUp 0.3s ease-out;
        }
        
        .chat-message.own {
            background: #a855f7;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.other {
            background: #374151;
            color: white;
            border-bottom-left-radius: 4px;
        }
        
        .chat-message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
            text-align: right;
        }
        
        /* Live video styles */
        .live-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #ef4444;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            z-index: 10;
        }
        
        .live-badge::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: white;
            border-radius: 50%;
            margin-right: 4px;
            animation: pulse 1.5s infinite;
        }
        
        /* User contribution stats */
        .contribution-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
        }
        
        /* Events styles */
        .event-card {
            background: #1f2937;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }
        
        .event-date {
            background: #4f46e5;
            color: white;
            text-align: center;
            padding: 10px;
            width: 70px;
        }
        
        .event-date .month {
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .event-date .day {
            font-size: 20px;
            font-weight: bold;
        }
        
        .event-date .weekday {
            font-size: 12px;
        }
        
        .event-category {
            display: inline-block;
            background: #ec4899;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .event-popular {
            background: #f59e0b;
        }
        
        .event-trending {
            background: #ef4444;
        }
        
        .events-search-bar {
            background: #1f2937;
            border-radius: 50px;
            padding: 10px 20px;
            margin-bottom: 20px;
        }
        
        .events-tabs {
            display: flex;
            border-bottom: 1px solid #374151;
            margin-bottom: 20px;
        }
        
        .events-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .events-tab.active {
            border-bottom-color: #a855f7;
            color: #a855f7;
        }
        
        .events-filter {
            background: #1f2937;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .events-results-count {
            color: #9ca3af;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        /* Profile modal */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .profile-content {
            background: #1f2937;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Star rating */
        .star-rating {
            display: flex;
            gap: 4px;
        }
        
        .star {
            color: #d1d5db;
            cursor: pointer;
            font-size: 24px;
        }
        
        .star.active {
            color: #facc15;
        }
        
        /* Cluster markers */
        .marker-cluster-small {
            background-color: rgba(181, 226, 140, 0.6);
        }
        
        .marker-cluster-small div {
            background-color: rgba(110, 204, 57, 0.6);
        }
        
        .marker-cluster-medium {
            background-color: rgba(241, 211, 87, 0.6);
        }
        
        .marker-cluster-medium div {
            background-color: rgba(240, 194, 12, 0.6);
        }
        
        .marker-cluster-large {
            background-color: rgba(253, 156, 115, 0.6);
        }
        
        .marker-cluster-large div {
            background-color: rgba(241, 128, 23, 0.6);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Loading Overlay and Notifications -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-white text-lg">Loading...</p>
        </div>
    </div>

    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Location Permission Modal -->
    <div id="location-permission-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4 text-white">Share Your Location</h3>
            <p class="text-gray-300 mb-4">
                Help improve party discovery by sharing your location. This helps us find the hottest spots in real-time and makes the app better for everyone!
            </p>
            <div class="flex space-x-4">
                <button id="allow-location" class="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700 transition-colors">
                    Allow Location
                </button>
                <button id="deny-location" class="flex-1 bg-gray-600 text-white py-2 rounded hover:bg-gray-700 transition-colors">
                    Not Now
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="profile-modal hidden">
        <div class="profile-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Your Profile</h2>
                <button id="close-profile" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <div class="flex items-center space-x-4">
                    <div class="w-20 h-20 rounded-full bg-gray-600 flex items-center justify-center">
                        <img id="profile-avatar" src="" alt="Avatar" class="w-full h-full rounded-full object-cover hidden">
                        <i class="fas fa-user text-3xl text-gray-400" id="profile-avatar-placeholder"></i>
                    </div>
                    <div>
                        <h3 id="profile-username" class="text-xl font-semibold"></h3>
                        <p id="profile-email" class="text-gray-400"></p>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Bio</label>
                    <textarea id="profile-bio" class="w-full px-3 py-2 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" rows="3" placeholder="Tell us about yourself..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Avatar</label>
                    <input type="file" id="profile-avatar-upload" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-500 file:text-white hover:file:bg-purple-600"/>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button id="cancel-profile" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button id="save-profile" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Feed Container -->
    <div id="video-feed-container" class="hidden fixed inset-0 z-50 bg-black">
        <button id="close-video-feed" class="absolute top-4 left-4 text-white z-50 p-3 rounded-full bg-gray-900/50 hover:bg-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <div id="video-feed-list" class="h-full overflow-y-scroll snap-y snap-mandatory"></div>
    </div>

    <div id="app-container">
        <!-- Header for the logged-in view - FIXED POSITIONING -->
        <header id="main-header" class="fixed top-0 left-0 right-0 p-4 flex justify-between items-center z-40 bg-gray-900 bg-opacity-90 backdrop-filter backdrop-blur-lg border-b border-gray-700 hidden">
            <h1 class="text-2xl font-extrabold tracking-widest text-gradient gradient-purple-pink">VIBEZ</h1>
            <div class="flex items-center space-x-4">
                <button id="profile-button" class="flex items-center space-x-2 text-white hover:text-purple-300 transition-colors">
                    <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center">
                        <img id="header-avatar" src="" alt="Avatar" class="w-full h-full rounded-full object-cover hidden">
                        <i class="fas fa-user text-gray-400" id="header-avatar-placeholder"></i>
                    </div>
                    <span id="user-info" class="font-semibold"></span>
                </button>
                <div class="flex items-center text-green-500 text-sm">
                    <span class="online-indicator"></span>
                    <span>Online</span>
                </div>
                <button id="logout-button" class="px-4 py-2 bg-pink-500 hover:bg-pink-600 text-white font-semibold rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 text-sm">
                    Logout
                </button>
            </div>
        </header>

        <!-- Main App Content (Dashboard) -->
        <div id="main-app-content" class="min-h-screen hidden">
            <!-- Tab Navigation - ADJUSTED MARGIN TOP -->
            <div class="flex justify-center space-x-8 mb-8 border-b border-gray-700 pt-20">
                <button id="map-tab" class="tab-button active px-4 py-2 font-semibold text-lg transition duration-300">
                    <span class="live-indicator"></span>Live Map
                </button>
                <button id="events-tab" class="tab-button px-4 py-2 font-semibold text-lg transition duration-300">
                    <i class="fas fa-calendar-alt mr-2"></i>Events
                </button>
                <button id="videos-tab" class="tab-button px-4 py-2 font-semibold text-lg transition duration-300">
                    <span class="live-indicator"></span>Live Videos
                </button>
                <button id="chat-tab" class="tab-button px-4 py-2 font-semibold text-lg transition duration-300">
                    <span class="live-indicator"></span>Real-Time Chat
                </button>
            </div>

            <!-- Tab Content -->
            <div id="tab-content" class="pb-8 px-4 md:px-8">
                <!-- Interactive Map Section -->
                <div id="map-content" class="tab-pane">
                    <div class="max-w-7xl mx-auto">
                        <!-- Location Action Buttons -->
                        <div class="absolute top-4 right-4 z-10 space-y-2">
                            <button id="share-location-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-blue-700 transition-colors flex items-center">
                                <i class="fas fa-share-location mr-2"></i>
                                Share My Location
                            </button>
                            <button id="check-in-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-green-700 transition-colors flex items-center">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                Check In
                            </button>
                        </div>

                        <div class="map-filters-container">
                            <!-- Filters Sidebar -->
                            <div id="filters-sidebar" class="bg-gray-800 rounded-lg shadow-xl">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-white text-lg">Live Filters</h3>
                                    <button id="toggle-filters" class="lg:hidden text-purple-400">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Party Type</label>
                                        <select id="party-type-filter" class="w-full bg-gray-700 text-white rounded-md p-2">
                                            <option value="all">All Types</option>
                                            <option value="HIPHOP">Hip Hop/R&B</option>
                                            <option value="AFROBEAT">Afrobeat</option>
                                            <option value="ELECTRONIC">Electronic/Dance</option>
                                            <option value="ROCK">Rock</option>
                                            <option value="OTHER">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Rating</label>
                                        <select id="rating-filter" class="w-full bg-gray-700 text-white rounded-md p-2">
                                            <option value="any">Any Rating</option>
                                            <option value="4.5">4.5+ Stars</option>
                                            <option value="4.0">4.0+ Stars</option>
                                            <option value="3.5">3.5+ Stars</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Vibe Level</label>
                                        <select id="vibe-filter" class="w-full bg-gray-700 text-white rounded-md p-2">
                                            <option value="any">Any Vibe</option>
                                            <option value="HIGH">High Energy</option>
                                            <option value="MEDIUM">Medium</option>
                                            <option value="CHILL">Chill</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Price Tier</label>
                                        <select id="price-filter" class="w-full bg-gray-700 text-white rounded-md p-2">
                                            <option value="all">All Prices</option>
                                            <option value="$">$ Cheap</option>
                                            <option value="$$">$$ Moderate</option>
                                            <option value="$$$">$$$ Expensive</option>
                                        </select>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="live-updates" class="rounded bg-gray-700 border-gray-600 text-purple-500 focus:ring-purple-500" checked>
                                        <label for="live-updates" class="ml-2 text-sm text-gray-300">Live Updates</label>
                                    </div>
                                    <button id="apply-filters" class="w-full py-3 px-4 rounded-md text-white font-semibold bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 transition-colors shadow-lg">
                                        Apply Filters
                                    </button>
                                    <button id="reset-filters" class="w-full py-2 px-4 rounded-md text-white font-semibold bg-gray-600 hover:bg-gray-700 transition-colors">
                                        Reset Filters
                                    </button>
                                    
                                    <!-- User Contribution Stats -->
                                    <div class="contribution-stats">
                                        <h4 class="font-semibold text-white mb-2">Your Contributions</h4>
                                        <div class="grid grid-cols-2 gap-2 text-sm">
                                            <div class="text-white">
                                                <div class="font-bold" id="user-checkins-count">0</div>
                                                <div class="text-blue-200">Check-ins</div>
                                            </div>
                                            <div class="text-white">
                                                <div class="font-bold" id="user-locations-added">0</div>
                                                <div class="text-blue-200">Locations Added</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Map Container -->
                            <div id="map-content-container">
                                <div id="map-container" class="w-full rounded-lg shadow-lg"></div>
                                <div class="mt-4 flex justify-between items-center">
                                    <div class="text-sm text-gray-400">
                                        <span id="filtered-count">0</span> of <span id="total-count">0</span> live locations
                                        <br>
                                        <span id="user-locations-count">0</span> user-discovered spots
                                    </div>
                                    <div class="flex items-center text-green-500 text-sm">
                                        <span class="online-indicator"></span>
                                        <span>Live Updates Active</span>
                                    </div>
                                    <button id="toggle-filters-button" class="lg:hidden bg-purple-600 text-white px-4 py-2 rounded-md">
                                        <i class="fas fa-filter mr-2"></i>Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Events Section -->
                <div id="events-content" class="tab-pane hidden">
                    <div class="max-w-7xl mx-auto">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl font-bold text-gradient gradient-teal-blue">
                                <i class="fas fa-calendar-alt mr-2"></i>Events Near You
                            </h2>
                            <div class="flex items-center text-green-500 text-sm">
                                <span class="online-indicator"></span>
                                <span>Live Updates</span>
                            </div>
                        </div>

                        <!-- Events Search and Filters -->
                        <div class="events-search-bar flex items-center">
                            <i class="fas fa-search text-gray-400 mr-3"></i>
                            <input type="text" id="events-search" placeholder="Search events, artists, venues..." class="flex-1 bg-transparent text-white focus:outline-none">
                            <button id="events-search-btn" class="bg-purple-600 text-white px-4 py-2 rounded-full hover:bg-purple-700 transition-colors ml-2">
                                Search
                            </button>
                        </div>

                        <div class="events-filter flex flex-wrap gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Time Frame</label>
                                <select id="events-timeframe" class="bg-gray-700 text-white rounded-md p-2">
                                    <option value="all">All Upcoming</option>
                                    <option value="today">Today</option>
                                    <option value="weekend">This Weekend</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Category</label>
                                <select id="events-category" class="bg-gray-700 text-white rounded-md p-2">
                                    <option value="all">All Categories</option>
                                    <option value="MUSIC">Music</option>
                                    <option value="FESTIVAL">Festival</option>
                                    <option value="CLUB">Club Night</option>
                                    <option value="CULTURAL">Cultural</option>
                                    <option value="SPORTS">Sports</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Sort By</label>
                                <select id="events-sort" class="bg-gray-700 text-white rounded-md p-2">
                                    <option value="popularity">Popularity</option>
                                    <option value="date">Date</option>
                                    <option value="distance">Distance</option>
                                    <option value="rating">Rating</option>
                                </select>
                            </div>
                        </div>

                        <div class="events-results-count">
                            About <span id="events-count">0</span> results near you
                        </div>

                        <!-- Events Grid -->
                        <div id="events-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Events will be dynamically loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Live Videos Section -->
                <div id="videos-content" class="tab-pane hidden">
                    <div class="max-w-7xl mx-auto">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl font-bold text-gradient gradient-orange-yellow">
                                <span class="live-indicator"></span>Live Videos
                            </h2>
                            <div class="flex items-center text-green-500 text-sm">
                                <span class="online-indicator"></span>
                                <span>Streaming Live</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <!-- Upload and manage videos -->
                            <div class="lg:col-span-1">
                                <div class="bg-gray-800 rounded-lg p-6 shadow-md mb-8">
                                    <h3 class="text-xl font-semibold mb-4">Upload a Video</h3>
                                    <form id="upload-form" class="space-y-4">
                                        <div>
                                            <label for="video-file" class="block text-sm font-medium text-gray-300">Video File (30s max)</label>
                                            <input type="file" id="video-file" accept="video/mp4,video/avi,video/mov,video/wmv" class="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-500 file:text-white hover:file:bg-purple-600"/>
                                        </div>
                                        <div>
                                            <label for="video-caption" class="block text-sm font-medium text-gray-300">Caption</label>
                                            <input type="text" id="video-caption" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500"/>
                                        </div>
                                        <div>
                                            <label for="video-location" class="block text-sm font-medium text-gray-300">Location</label>
                                            <select id="video-location" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-purple-500 focus:ring-purple-500">
                                                <option value="">Select a location</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="w-full py-2 px-4 rounded-md text-white font-semibold bg-pink-500 hover:bg-pink-600">
                                            Upload & Share Live
                                        </button>
                                    </form>
                                </div>
                                <div class="bg-gray-800 rounded-lg p-6 shadow-md">
                                    <h3 class="text-xl font-semibold mb-4">Your Uploads</h3>
                                    <div id="my-videos" class="space-y-4">
                                        <!-- User's videos will be dynamically loaded here -->
                                    </div>
                                </div>
                            </div>

                            <!-- All videos feed -->
                            <div class="lg:col-span-2 relative">
                                <div id="all-videos" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <!-- All videos will be dynamically loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Real-Time Chat Section -->
                <div id="chat-content" class="tab-pane hidden">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl font-bold text-gradient gradient-teal-blue">
                                <span class="live-indicator"></span>Real-Time Chat
                            </h2>
                            <div class="flex items-center text-green-500 text-sm">
                                <span class="online-indicator"></span>
                                <span id="online-users-count">1 user online</span>
                            </div>
                        </div>
                        <div class="flex flex-col lg:flex-row gap-8 h-[600px]">
                            <!-- Active Users Sidebar -->
                            <div class="bg-gray-800 rounded-lg shadow-lg p-4 w-full lg:w-1/4 h-full">
                                <h3 class="text-xl font-semibold mb-4">Active Users</h3>
                                <ul id="active-users-list" class="space-y-2 text-gray-300">
                                    <!-- Active users will be dynamically added here -->
                                </ul>
                            </div>
                            <!-- Chat Box -->
                            <div class="bg-gray-800 rounded-lg shadow-lg w-full lg:w-3/4 h-full flex flex-col relative">
                                <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4">
                                    <!-- Chat messages will be dynamically added here -->
                                </div>
                                <div class="p-4 border-t border-gray-700">
                                    <div class="flex space-x-2">
                                        <input type="text" id="chat-input" placeholder="Type a message..." class="flex-1 px-4 py-2 rounded-full bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <button id="send-chat" class="px-4 py-2 bg-purple-600 text-white rounded-full hover:bg-purple-700 transition-colors">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Marketing/Landing Page Content -->
        <div id="landing-page" class="min-h-screen">
            <!-- App Title at the very top -->
            <header class="fixed top-0 left-0 right-0 p-6 z-50 bg-gray-900 bg-opacity-90 backdrop-filter backdrop-blur-lg">
                <h1 class="text-3xl md:text-4xl font-extrabold tracking-widest text-gradient gradient-purple-pink">VIBEZ</h1>
            </header>

            <!-- Hero Section -->
            <section class="relative min-h-screen flex items-center justify-center text-center p-4 pt-24">
                <div class="absolute inset-0 bg-cover bg-center opacity-30" style="background-image: url('https://images.unsplash.com/photo-1533174072545-7a4b6ad7a6c3?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80');"></div>
                <div class="relative z-10 p-8 rounded-2xl bg-gray-800 bg-opacity-80 backdrop-filter backdrop-blur-lg border border-gray-700">
                    <h1 class="text-5xl md:text-7xl font-extrabold tracking-tight leading-tight text-gradient gradient-purple-pink mb-2 animate-fade-in-down">
                        Find Your Vibe
                    </h1>
                    <p class="text-2xl md:text-3xl text-gray-200 mb-8 animate-fade-in-up">
                        Real-Time Party & Events Finder
                    </p>
                    <p class="text-xl md:text-2xl text-gray-300 mb-8 animate-fade-in-up">
                        Discover the hottest parties, events, and chill spots happening right now with live updates.
                    </p>
                    <button id="get-started-button" class="px-8 py-4 text-lg font-bold text-white bg-purple-600 rounded-full shadow-lg hover:bg-purple-700 transition duration-300 ease-in-out transform hover:scale-105">
                        Get Started
                    </button>
                </div>
            </section>

            <!-- About Section -->
            <section id="about" class="py-20 px-8 md:px-20 text-center">
                <h2 class="text-4xl font-bold text-gradient gradient-teal-blue mb-8">
                    About Vibez
                </h2>
                <div class="max-w-4xl mx-auto text-gray-300 text-lg">
                    <p class="mb-4">
                        Vibez is the ultimate real-time platform for discovering the best social events and party locations. Our mission is to connect you with the most vibrant spots as they happen.
                    </p>
                    <p>
                        With live user updates, real-time video posts, and instant chat, you'll always know where the action is right now.
                    </p>
                </div>
            </section>

            <!-- Features Section -->
            <section id="features" class="py-20 px-8 md:px-20 bg-gray-800 border-t border-b border-gray-700">
                <h2 class="text-4xl font-bold text-center text-gradient gradient-orange-yellow mb-12">
                    Real-Time Features
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-12 max-w-6xl mx-auto">
                    <div class="bg-gray-900 rounded-xl p-8 text-center shadow-lg transform transition duration-500 hover:scale-105 hover:bg-gray-700">
                        <div class="text-4xl text-yellow-500 mb-4">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <h3 class="text-2xl font-semibold mb-4 text-white">Live Interactive Map</h3>
                        <p class="text-gray-400">
                            See parties and events on a real-time map with live location updates and crowd levels.
                        </p>
                    </div>
                    <div class="bg-gray-900 rounded-xl p-8 text-center shadow-lg transform transition duration-500 hover:scale-105 hover:bg-gray-700">
                        <div class="text-4xl text-red-500 mb-4">
                            <i class="fas fa-video"></i>
                        </div>
                        <h3 class="text-2xl font-semibold mb-4 text-white">Live Video Streams</h3>
                        <p class="text-gray-400">
                            Watch and share 30-second videos of party experiences in real-time.
                        </p>
                    </div>
                    <div class="bg-gray-900 rounded-xl p-8 text-center shadow-lg transform transition duration-500 hover:scale-105 hover:bg-gray-700">
                        <div class="text-4xl text-blue-500 mb-4">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h3 class="text-2xl font-semibold mb-4 text-white">Instant Chat</h3>
                        <p class="text-gray-400">
                            Connect with people at the same party location via real-time text chat.
                        </p>
                    </div>
                </div>
            </section>
            
            <!-- Call to Action -->
            <section class="py-20 px-8 md:px-20 text-center">
                <h2 class="text-3xl font-bold text-white mb-8">Ready to Find Your Vibe in Real-Time?</h2>
                <button id="join-now-button" class="px-8 py-4 text-lg font-bold text-white bg-gradient-to-r from-purple-600 to-pink-600 rounded-full shadow-lg hover:from-purple-700 hover:to-pink-700 transition duration-300 ease-in-out transform hover:scale-105">
                    Join Now
                </button>
            </section>

            <!-- Footer -->
            <footer class="py-8 text-center text-gray-400 border-t border-gray-700">
                <p>&copy; 2025 Vibez. All rights reserved.</p>
            </footer>
        </div>

        <!-- Authentication Forms -->
        <div id="auth-container" class="min-h-screen flex flex-col items-center justify-center p-4 hidden">
            <div id="form-card" class="w-full max-w-lg p-8 bg-gray-800 rounded-2xl shadow-2xl backdrop-filter backdrop-blur-lg bg-opacity-70 border border-gray-700 transition-all duration-500 ease-in-out transform scale-100">
                <h2 id="form-title" class="text-3xl font-bold text-center text-white mb-6">Welcome Back!</h2>
                <p id="form-subtitle" class="text-center text-gray-400 mb-8">Log in to find the hottest parties in real-time.</p>

                <div id="error-message" class="bg-red-500 text-white px-4 py-3 rounded-lg mb-6 text-sm text-center hidden"></div>

                <form id="login-form" class="space-y-6">
                    <input type="email" id="login-email" placeholder="Email Address" class="w-full px-5 py-3 bg-gray-700 text-white rounded-xl border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-gray-400 transition duration-300" required>
                    <input type="password" id="login-password" placeholder="Password" class="w-full px-5 py-3 bg-gray-700 text-white rounded-xl border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-gray-400 transition duration-300" required>
                    <button type="submit" id="login-submit" class="w-full px-5 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-xl shadow-lg hover:from-purple-700 hover:to-pink-700 transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                        Login
                    </button>
                </form>

                <form id="register-form" class="space-y-6 hidden">
                    <input type="text" id="register-username" placeholder="Username" class="w-full px-5 py-3 bg-gray-700 text-white rounded-xl border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-gray-400 transition duration-300" required>
                    <input type="email" id="register-email" placeholder="Email Address" class="w-full px-5 py-3 bg-gray-700 text-white rounded-xl border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-gray-400 transition duration-300" required>
                    <input type="password" id="register-password" placeholder="Password" class="w-full px-5 py-3 bg-gray-700 text-white rounded-xl border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-gray-400 transition duration-300" required>
                    <button type="submit" id="register-submit" class="w-full px-5 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold rounded-xl shadow-lg hover:from-purple-700 hover:to-pink-700 transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                        Register
                    </button>
                </form>

                <div id="toggle-auth" class="text-center mt-8 text-gray-400">
                    Don't have an account? 
                    <button id="toggle-button" class="text-purple-400 hover:text-purple-300 font-semibold ml-2 transition duration-300">
                        Sign Up
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Marker Cluster -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <script>
        // API Configuration
        const API_CONFIG = {
            BASE_URL: '/api',
            TICKETMASTER_API_KEY: '7IxmuowYQAzGbY84Qwj0lCGjGHbxVQxv',
            OPENSTREETMAP_NOMINATIM_URL: 'https://nominatim.openstreetmap.org/search',
            TICKETMASTER_BASE_URL: 'https://app.ticketmaster.com/discovery/v2/events.json',
            OVERPASS_API_URL: 'https://overpass-api.de/api/interpreter'
        };

        // Real-time configuration
        const REAL_TIME_CONFIG = {
            MAP_UPDATE_INTERVAL: 30000, // 30 seconds
            VIDEO_UPDATE_INTERVAL: 20000, // 20 seconds
            CHAT_UPDATE_INTERVAL: 8000, // 8 seconds
            USER_PRESENCE_INTERVAL: 30000, // 30 seconds
            LOCATION_TRACKING_INTERVAL: 60000, // 1 minute
            EVENTS_UPDATE_INTERVAL: 60000, // 1 minute
        };

        // DOM Elements
        const appContainer = document.getElementById('app-container');
        const landingPage = document.getElementById('landing-page');
        const authContainer = document.getElementById('auth-container');
        const mainAppContent = document.getElementById('main-app-content');
        const mainHeader = document.getElementById('main-header');
        const logoutButton = document.getElementById('logout-button');
        const userInfo = document.getElementById('user-info');
        const getStartedButton = document.getElementById('get-started-button');
        const joinNowButton = document.getElementById('join-now-button');
        const profileButton = document.getElementById('profile-button');
        const profileModal = document.getElementById('profile-modal');
        const closeProfileButton = document.getElementById('close-profile');
        const cancelProfileButton = document.getElementById('cancel-profile');
        const saveProfileButton = document.getElementById('save-profile');
        const profileAvatar = document.getElementById('profile-avatar');
        const profileAvatarPlaceholder = document.getElementById('profile-avatar-placeholder');
        const headerAvatar = document.getElementById('header-avatar');
        const headerAvatarPlaceholder = document.getElementById('header-avatar-placeholder');
        const profileUsername = document.getElementById('profile-username');
        const profileEmail = document.getElementById('profile-email');
        const profileBio = document.getElementById('profile-bio');
        const profileAvatarUpload = document.getElementById('profile-avatar-upload');

        // Authentication elements
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const toggleButton = document.getElementById('toggle-button');
        const formTitle = document.getElementById('form-title');
        const formSubtitle = document.getElementById('form-subtitle');
        const errorMessage = document.getElementById('error-message');

        // Dashboard elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const mapTab = document.getElementById('map-tab');
        const eventsTab = document.getElementById('events-tab');
        const videosTab = document.getElementById('videos-tab');
        const chatTab = document.getElementById('chat-tab');

        // Map and filter elements
        const mapContainer = document.getElementById('map-container');
        const filtersSidebar = document.getElementById('filters-sidebar');
        const applyFiltersButton = document.getElementById('apply-filters');
        const resetFiltersButton = document.getElementById('reset-filters');
        const toggleFiltersButton = document.getElementById('toggle-filters-button');
        const toggleFilters = document.getElementById('toggle-filters');
        const filteredCount = document.getElementById('filtered-count');
        const totalCount = document.getElementById('total-count');
        const userLocationsCount = document.getElementById('user-locations-count');
        const liveUpdatesCheckbox = document.getElementById('live-updates');
        const shareLocationBtn = document.getElementById('share-location-btn');
        const checkInBtn = document.getElementById('check-in-btn');
        const locationPermissionModal = document.getElementById('location-permission-modal');
        const allowLocationBtn = document.getElementById('allow-location');
        const denyLocationBtn = document.getElementById('deny-location');
        const userCheckinsCount = document.getElementById('user-checkins-count');
        const userLocationsAdded = document.getElementById('user-locations-added');

        // Video elements
        const uploadForm = document.getElementById('upload-form');
        const videoFile = document.getElementById('video-file');
        const videoCaption = document.getElementById('video-caption');
        const videoLocationSelect = document.getElementById('video-location');
        const myVideosContainer = document.getElementById('my-videos');
        const allVideosContainer = document.getElementById('all-videos');

        // Chat elements
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const activeUsersList = document.getElementById('active-users-list');
        const sendChatButton = document.getElementById('send-chat');
        const onlineUsersCount = document.getElementById('online-users-count');

        // Events elements
        const eventsSearch = document.getElementById('events-search');
        const eventsSearchBtn = document.getElementById('events-search-btn');
        const eventsTimeframe = document.getElementById('events-timeframe');
        const eventsCategory = document.getElementById('events-category');
        const eventsSort = document.getElementById('events-sort');
        const eventsCount = document.getElementById('events-count');
        const eventsGrid = document.getElementById('events-grid');

        // Video Feed elements
        const videoFeedContainer = document.getElementById('video-feed-container');
        const videoFeedList = document.getElementById('video-feed-list');
        const closeFeedButton = document.getElementById('close-video-feed');

        // State variables
        let isLogin = true;
        let map = null;
        let markers = [];
        let eventMarkers = [];
        let allLocations = [];
        let filteredLocations = [];
        let allEvents = [];
        let filteredEvents = [];
        let allVideos = [];
        let myVideos = [];
        let videoData = [];
        let activeUsers = [];
        let currentUser = null;
        let userLocation = null;
        let updateIntervals = {
            map: null,
            events: null,
            videos: null,
            chat: null,
            users: null,
            location: null
        };
        let chatSocket = null;
        let currentChatRoom = 'general';
        let markerCluster = null;

        // Utility functions
        const showLoading = (show = true) => {
            const loader = document.getElementById('loading-overlay');
            if (show) {
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }
        };

        const showNotification = (message, type = 'info') => {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 
                           type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
            
            notification.className = `${bgColor} text-white p-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300`;
            notification.textContent = message;
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.remove('translate-x-full'), 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        };

        // API Functions
        const apiRequest = async (endpoint, options = {}) => {
            const token = localStorage.getItem('authToken');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Token ${token}` }),
                    ...options.headers
                }
            };

            const response = await fetch(`${API_CONFIG.BASE_URL}${endpoint}`, {
                ...defaultOptions,
                ...options
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }

            return response.json();
        };

        const fetchPartyLocations = async () => {
            try {
                const data = await apiRequest('/partylocations/');
                return data.results || data;
            } catch (error) {
                console.error('Failed to fetch party locations:', error);
                showNotification('Failed to load party locations', 'error');
                return [];
            }
        };

        const fetchEvents = async () => {
            try {
                const data = await apiRequest('/events/');
                return data.results || data;
            } catch (error) {
                console.error('Failed to fetch events:', error);
                showNotification('Failed to load events', 'error');
                return [];
            }
        };

        const fetchVideos = async () => {
            try {
                const data = await apiRequest('/videos/');
                return data.results || data;
            } catch (error) {
                console.error('Failed to fetch videos:', error);
                showNotification('Failed to load videos', 'error');
                return [];
            }
        };

        const fetchUserProfile = async () => {
            try {
                const data = await apiRequest('/profile/');
                return data;
            } catch (error) {
                console.error('Failed to fetch user profile:', error);
                return null;
            }
        };

        const updateUserProfile = async (profileData) => {
            try {
                const formData = new FormData();
                
                if (profileData.bio !== undefined) {
                    formData.append('bio', profileData.bio);
                }
                
                if (profileData.avatar instanceof File) {
                    formData.append('avatar', profileData.avatar);
                }

                const response = await fetch(`${API_CONFIG.BASE_URL}/profile/`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Token ${localStorage.getItem('authToken')}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Failed to update profile: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Error updating profile:', error);
                throw error;
            }
        };

        const submitRating = async (locationId, score) => {
            try {
                await apiRequest('/rankings/', {
                    method: 'POST',
                    body: JSON.stringify({
                        party_location: locationId,
                        score: score
                    })
                });
                return true;
            } catch (error) {
                console.error('Failed to submit rating:', error);
                showNotification('Failed to submit rating', 'error');
                return false;
            }
        };

        const uploadVideo = async (formData) => {
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/videos/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${localStorage.getItem('authToken')}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Video upload error:', error);
                throw error;
            }
        };

        const deleteVideo = async (videoId) => {
            try {
                await apiRequest(`/videos/${videoId}/`, {
                    method: 'DELETE'
                });
                return true;
            } catch (error) {
                console.error('Failed to delete video:', error);
                showNotification('Failed to delete video', 'error');
                return false;
            }
        };

        const checkInToLocation = async (locationId) => {
            try {
                await apiRequest('/checkins/', {
                    method: 'POST',
                    body: JSON.stringify({
                        party_location: locationId
                    })
                });
                return true;
            } catch (error) {
                console.error('Failed to check in:', error);
                showNotification('Failed to check in', 'error');
                return false;
            }
        };

        const createNewLocation = async (locationData) => {
            try {
                const newLocation = await apiRequest('/partylocations/', {
                    method: 'POST',
                    body: JSON.stringify(locationData)
                });
                return newLocation;
            } catch (error) {
                console.error('Failed to create location:', error);
                showNotification('Failed to create location', 'error');
                return null;
            }
        };

        // VIEW MANAGEMENT
        const showMainApp = (username, userId) => {
            landingPage.classList.add('hidden');
            authContainer.classList.add('hidden');
            mainAppContent.classList.remove('hidden');
            mainHeader.classList.remove('hidden');
            userInfo.textContent = username;
            
            currentUser = {
                username,
                userId,
                lastActive: new Date()
            };
            
            // Add current user to active users
            activeUsers = [currentUser];
            updateActiveUsersList();
            
            localStorage.setItem('username', username);
            localStorage.setItem('userId', userId);
            
            // Load user profile
            loadUserProfile();
            
            // Start real-time updates
            startRealTimeUpdates();
            
            // Show location permission modal after a short delay
            setTimeout(() => {
                locationPermissionModal.classList.remove('hidden');
            }, 1000);
            
            showTab('map');
        };

        const showAuthForm = () => {
            landingPage.classList.add('hidden');
            authContainer.classList.remove('hidden');
            mainAppContent.classList.add('hidden');
            mainHeader.classList.add('hidden');
            errorMessage.classList.add('hidden');
            
            // Stop real-time updates when showing auth form
            stopRealTimeUpdates();
        };

        const showLandingPage = () => {
            landingPage.classList.remove('hidden');
            authContainer.classList.add('hidden');
            mainAppContent.classList.add('hidden');
            mainHeader.classList.add('hidden');
            
            // Stop real-time updates when showing landing page
            stopRealTimeUpdates();
        };

        // TAB MANAGEMENT
        const showTab = (tabId) => {
            tabPanes.forEach(pane => pane.classList.add('hidden'));
            tabButtons.forEach(button => button.classList.remove('active'));
            document.getElementById(`${tabId}-content`).classList.remove('hidden');
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            if (tabId === 'map') {
                if (!map) {
                    initMap();
                }
                updateLocationSelect();
            } else if (tabId === 'events') {
                loadEvents();
            } else if (tabId === 'videos') {
                loadVideos();
                updateLocationSelect();
            } else if (tabId === 'chat') {
                connectChat();
            }
        };

        // AUTHENTICATION FUNCTIONS
        const handleLogin = async (email, password) => {
            showLoading(true);
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/login/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Login failed');
                }

                const data = await response.json();
                localStorage.setItem('authToken', data.token);
                showMainApp(data.username, data.user_id || 'user123');
                showNotification('Login successful! Real-time updates activated', 'success');
            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        };

        const handleRegister = async (username, email, password) => {
            showLoading(true);
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/register/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        password: password
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMessage = Object.values(errorData).flat().join(', ') || 'Registration failed';
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                localStorage.setItem('authToken', data.token);
                showMainApp(data.username, data.user_id || 'user123');
                showNotification('Registration successful! Real-time updates activated', 'success');
            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        };

        const showError = (message) => {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        };

        const toggleAuthForm = () => {
            isLogin = !isLogin;
            
            if (isLogin) {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                formTitle.textContent = 'Welcome Back!';
                formSubtitle.textContent = 'Log in to find the hottest parties in real-time.';
                toggleButton.textContent = 'Sign Up';
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                formTitle.textContent = 'Join Vibez!';
                formSubtitle.textContent = 'Create an account to start exploring parties in real-time.';
                toggleButton.textContent = 'Login';
            }
            errorMessage.classList.add('hidden');
        };

        const logout = () => {
            localStorage.removeItem('authToken');
            localStorage.removeItem('username');
            localStorage.removeItem('userId');
            if (chatSocket) {
                chatSocket.close();
            }
            stopRealTimeUpdates();
            showLandingPage();
            showNotification('Logged out successfully', 'success');
        };

        // USER PROFILE FUNCTIONS
        const loadUserProfile = async () => {
            try {
                const profile = await fetchUserProfile();
                if (profile) {
                    updateProfileUI(profile);
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        };

        const updateProfileUI = (profile) => {
            profileUsername.textContent = profile.username || currentUser.username;
            profileEmail.textContent = profile.email || '';
            profileBio.value = profile.bio || '';
            
            // Update avatar if available
            if (profile.avatar) {
                profileAvatar.src = profile.avatar;
                profileAvatar.classList.remove('hidden');
                profileAvatarPlaceholder.classList.add('hidden');
                
                headerAvatar.src = profile.avatar;
                headerAvatar.classList.remove('hidden');
                headerAvatarPlaceholder.classList.add('hidden');
            } else {
                profileAvatar.classList.add('hidden');
                profileAvatarPlaceholder.classList.remove('hidden');
                
                headerAvatar.classList.add('hidden');
                headerAvatarPlaceholder.classList.remove('hidden');
            }
        };

        const handleProfileUpdate = async () => {
            showLoading(true);
            try {
                const profileData = {
                    bio: profileBio.value
                };
                
                if (profileAvatarUpload.files.length > 0) {
                    profileData.avatar = profileAvatarUpload.files[0];
                }
                
                const updatedProfile = await updateUserProfile(profileData);
                updateProfileUI(updatedProfile);
                profileModal.classList.add('hidden');
                showNotification('Profile updated successfully', 'success');
            } catch (error) {
                showNotification('Failed to update profile', 'error');
            } finally {
                showLoading(false);
            }
        };

        // MAP FUNCTIONS - USING LEAFLET.JS
        const initMap = () => {
            // Default to a central location if user location not available
            const defaultLocation = [0.3476, 32.5825]; // Default to Kampala
            
            // Initialize the map
            map = L.map('map-container').setView(defaultLocation, 12);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Initialize marker cluster
            markerCluster = L.markerClusterGroup();
            map.addLayer(markerCluster);
            
            // Add context menu for creating new locations
            map.on('contextmenu', function(e) {
                L.popup()
                    .setLatLng(e.latlng)
                    .setContent(`
                        <div class="text-white">
                            <h3 class="font-bold mb-2">Add New Party Spot</h3>
                            <input type="text" id="new-location-name" placeholder="Location name" class="w-full p-2 mb-2 rounded bg-gray-700 text-white">
                            <button onclick="createLocationAt(${e.latlng.lat}, ${e.latlng.lng})" class="w-full py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
                                Create Location
                            </button>
                        </div>
                    `)
                    .openOn(map);
            });
            
            // Load real data
            loadMapData(defaultLocation[0], defaultLocation[1]);
            
            // Initialize filter counts
            updateFilterCounts();
            updateUserStats();
        };

        const loadMapData = async (lat, lon) => {
            showLoading(true);
            try {
                // Fetch locations from your API
                const locations = await fetchPartyLocations();
                allLocations = locations;
                filteredLocations = [...allLocations];
                
                // Add markers to map
                addLocationsToMap();
                
                // Update UI
                updateFilterCounts();
                
                showNotification('Map data loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading map data:', error);
                showNotification('Error loading map data', 'error');
            } finally {
                showLoading(false);
            }
        };

        const addLocationsToMap = () => {
            // Clear existing markers
            markerCluster.clearLayers();
            markers = [];

            // Add new markers
            allLocations.forEach(location => {
                addMarkerToMap(location);
            });
        };

        const addMarkerToMap = (location) => {
            // Determine marker class based on rating
            let markerClass = 'party-marker';
            if (location.average_rating >= 4.5) {
                markerClass += ' top-rated';
            } else if (location.average_rating >= 4.0) {
                markerClass += ' high-rated';
            }

            // Create custom icon
            const customIcon = L.divIcon({
                className: markerClass,
                iconSize: [20, 20],
                html: ''
            });

            // Create marker with custom icon
            const marker = L.marker([location.latitude, location.longitude], { icon: customIcon });
            
            // Create star rating HTML
            const starRatingHtml = Array(5).fill(0).map((_, i) => 
                `<span class="star ${i < Math.floor(location.average_rating || 0) ? 'active' : ''}" data-rating="${i+1}"></span>`
            ).join('');
            
            marker.bindPopup(`
                <div class="text-white min-w-64">
                    <h3 class="font-bold text-lg">${location.name}</h3>
                    <p class="text-sm">${location.description || 'No description available'}</p>
                    <div class="my-2">
                        <div class="flex justify-between text-sm">
                            <span>Rating: ${(location.average_rating || 0).toFixed(1)}/5</span>
                            <span>Vibe: ${location.vibe_level || 'Unknown'}</span>
                        </div>
                        <div class="star-rating my-1" data-location-id="${location.id}">
                            ${starRatingHtml}
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Crowd: ${location.current_crowd || 0}%</span>
                            <span>Price: ${location.price_tier || '$'}</span>
                        </div>
                    </div>
                    <div class="mt-2 flex space-x-2">
                        <button onclick="checkInToLocationFromMap(${location.id})" class="flex-1 px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors">
                            Check In
                        </button>
                        <button onclick="joinLocationChat(${location.id})" class="flex-1 px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors">
                            Join Chat
                        </button>
                    </div>
                </div>
            `);
            
            marker.on('popupopen', function() {
                // Add event listeners for star ratings
                const starContainer = document.querySelector(`.star-rating[data-location-id="${location.id}"]`);
                if (starContainer) {
                    const stars = starContainer.querySelectorAll('.star');
                    stars.forEach(star => {
                        star.addEventListener('click', async () => {
                            const rating = parseInt(star.getAttribute('data-rating'));
                            const success = await submitRating(location.id, rating);
                            if (success) {
                                // Update UI
                                stars.forEach((s, i) => {
                                    s.classList.toggle('active', i < rating);
                                });
                                showNotification(`Rated ${location.name} ${rating} stars!`, 'success');
                            }
                        });
                    });
                }
            });
            
            markerCluster.addLayer(marker);
            markers.push({ marker, location });
        };

        const createLocationAt = async (lat, lng) => {
            const nameInput = document.getElementById('new-location-name');
            const name = nameInput ? nameInput.value : 'New Party Spot';
            
            if (!name.trim()) {
                showNotification('Please enter a location name', 'error');
                return;
            }
            
            const newLocation = await createNewLocation({
                name: name,
                latitude: lat,
                longitude: lng,
                address: 'User-added location',
                city: 'Unknown',
                genre: 'OTHER',
                price_tier: '$',
                vibe_level: 'MEDIUM'
            });
            
            if (newLocation) {
                allLocations.push(newLocation);
                addMarkerToMap(newLocation);
                updateLocationSelect();
                updateFilterCounts();
                updateUserStats();
                map.closePopup();
                showNotification(`New location "${name}" created!`, 'success');
            }
        };

        const applyMapFilters = () => {
            const partyType = document.getElementById('party-type-filter').value;
            const rating = document.getElementById('rating-filter').value;
            const vibe = document.getElementById('vibe-filter').value;
            const price = document.getElementById('price-filter').value;
            
            // Filter locations based on selected criteria
            filteredLocations = allLocations.filter(location => {
                // Filter by party type (genre)
                if (partyType !== 'all' && location.genre !== partyType) {
                    return false;
                }
                
                // Filter by rating
                if (rating !== 'any' && (location.average_rating || 0) < parseFloat(rating)) {
                    return false;
                }
                
                // Filter by vibe
                if (vibe !== 'any' && location.vibe_level !== vibe) {
                    return false;
                }
                
                // Filter by price
                if (price !== 'all' && location.price_tier !== price) {
                    return false;
                }
                
                return true;
            });
            
            // Update markers visibility
            markerCluster.clearLayers();
            filteredLocations.forEach(location => {
                const markerObj = markers.find(m => m.location.id === location.id);
                if (markerObj) {
                    markerCluster.addLayer(markerObj.marker);
                }
            });
            
            // Update filter counts
            updateFilterCounts();
            
            // Show notification
            showNotification(`Filters applied! Showing ${filteredLocations.length} locations`, 'success');
        };

        const resetMapFilters = () => {
            // Reset filter dropdowns to default values
            document.getElementById('party-type-filter').value = 'all';
            document.getElementById('rating-filter').value = 'any';
            document.getElementById('vibe-filter').value = 'any';
            document.getElementById('price-filter').value = 'all';
            
            // Reset to show all locations
            filteredLocations = [...allLocations];
            
            // Show all markers
            markerCluster.clearLayers();
            markers.forEach(({ marker }) => {
                markerCluster.addLayer(marker);
            });
            
            // Update filter counts
            updateFilterCounts();
            
            // Show notification
            showNotification('Filters reset', 'info');
        };

        const updateFilterCounts = () => {
            filteredCount.textContent = filteredLocations.length;
            totalCount.textContent = allLocations.length;
            userLocationsCount.textContent = allLocations.filter(loc => loc.user_generated).length;
        };

        const toggleFiltersVisibility = () => {
            filtersSidebar.classList.toggle('open');
        };

        const updateLocationSelect = () => {
            // Update the location select dropdown for video uploads
            videoLocationSelect.innerHTML = '<option value="">Select a location</option>';
            allLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = location.id;
                option.textContent = location.name;
                videoLocationSelect.appendChild(option);
            });
        };

        // Location functions
        const checkInToLocationFromMap = async (locationId) => {
            const success = await checkInToLocation(locationId);
            if (success) {
                // Update location stats locally
                const location = allLocations.find(loc => loc.id === locationId);
                if (location) {
                    location.current_crowd = Math.min(100, (location.current_crowd || 0) + 5);
                    location.total_checkins = (location.total_checkins || 0) + 1;
                }
                
                // Update user stats
                updateUserStats();
                
                showNotification(` Checked in successfully!`, 'success');
            }
        };

        const joinLocationChat = (locationId) => {
            const location = allLocations.find(loc => loc.id === locationId);
            if (location) {
                // Switch to chat tab and join location-specific room
                showTab('chat');
                switchChatRoom(`location_${locationId}`);
                showNotification(`Joined chat for ${location.name}`, 'info');
            }
        };

        const updateUserStats = () => {
            // For demo purposes - in a real app, you'd fetch this from the API
            const userCheckins = Math.floor(Math.random() * 20);
            const userLocations = allLocations.filter(loc => loc.user_generated).length;
            
            userCheckinsCount.textContent = userCheckins;
            userLocationsAdded.textContent = userLocations;
        }

        // EVENTS FUNCTIONS
        const loadEvents = async () => {
            showLoading(true);
            try {
                const events = await fetchEvents();
                allEvents = events;
                filteredEvents = [...allEvents];
                
                renderEvents();
                showLoading(false);
            } catch (error) {
                console.error('Failed to fetch events:', error);
                showLoading(false);
            }
        };

        const renderEvents = () => {
            // Apply filters
            applyEventFilters();
            
            // Render events grid
            eventsGrid.innerHTML = filteredEvents.map(event => `
                <div class="event-card">
                    <div class="flex">
                        <div class="event-date">
                            <div class="month">${new Date(event.start_date).toLocaleDateString('en-US', { month: 'short' }).toUpperCase()}</div>
                            <div class="day">${new Date(event.start_date).getDate()}</div>
                            <div class="weekday">${new Date(event.start_date).toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase()}</div>
                        </div>
                        <div class="p-4 flex-1">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-white text-lg">${event.name}</h3>
                                <div class="flex space-x-1">
                                    ${event.is_popular ? '<span class="event-category event-popular">POPULAR</span>' : ''}
                                    ${event.is_trending ? '<span class="event-category event-trending">TRENDING</span>' : ''}
                                </div>
                            </div>
                            <p class="text-gray-400 text-sm mb-2">${event.category.toUpperCase()}</p>
                            <p class="text-gray-300 mb-2">${event.party_location_name}  ${new Date(event.start_date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                            <p class="text-gray-400 text-sm mb-3">${event.description}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300 text-sm"> ${event.actual_attendees || 0} attendees</span>
                                <span class="text-gray-300 text-sm"> ${event.price_tier}</span>
                            </div>
                            <div class="mt-3 flex space-x-2">
                                <button onclick="viewEventDetails(${event.id})" class="flex-1 px-3 py-2 bg-purple-600 text-white rounded text-sm hover:bg-purple-700 transition-colors">
                                    View Details
                                </button>
                                <button onclick="rsvpToEvent(${event.id})" class="flex-1 px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors">
                                    RSVP
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Update events count
            eventsCount.textContent = filteredEvents.length;
        };

        const applyEventFilters = () => {
            const timeframe = eventsTimeframe.value;
            const category = eventsCategory.value;
            const sort = eventsSort.value;
            const search = eventsSearch.value.toLowerCase();
            
            // Filter events based on selected criteria
            filteredEvents = allEvents.filter(event => {
                // Filter by search
                if (search && !event.name.toLowerCase().includes(search) && 
                    !event.party_location_name.toLowerCase().includes(search) && 
                    !event.description.toLowerCase().includes(search)) {
                    return false;
                }
                
                // Filter by category
                if (category !== 'all' && event.category !== category) {
                    return false;
                }
                
                // Filter by timeframe
                const now = new Date();
                const eventDate = new Date(event.start_date);
                
                if (timeframe === 'today') {
                    return eventDate.toDateString() === now.toDateString();
                } else if (timeframe === 'weekend') {
                    const dayOfWeek = eventDate.getDay();
                    const daysUntilWeekend = (6 - now.getDay() + 7) % 7; // Days until Saturday
                    const weekendStart = new Date(now);
                    weekendStart.setDate(now.getDate() + daysUntilWeekend);
                    const weekendEnd = new Date(weekendStart);
                    weekendEnd.setDate(weekendStart.getDate() + 1); // Sunday
                    
                    return eventDate >= weekendStart && eventDate <= weekendEnd;
                } else if (timeframe === 'week') {
                    const weekEnd = new Date(now);
                    weekEnd.setDate(now.getDate() + 7);
                    return eventDate >= now && eventDate <= weekEnd;
                } else if (timeframe === 'month') {
                    const monthEnd = new Date(now);
                    monthEnd.setMonth(now.getMonth() + 1);
                    return eventDate >= now && eventDate <= monthEnd;
                }
                
                // Default: all upcoming events
                return eventDate >= now;
            });
            
            // Sort events
            if (sort === 'date') {
                filteredEvents.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));
            } else if (sort === 'popularity') {
                filteredEvents.sort((a, b) => {
                    const aScore = (a.is_popular ? 2 : 0) + (a.is_trending ? 1 : 0);
                    const bScore = (b.is_popular ? 2 : 0) + (b.is_trending ? 1 : 0);
                    return bScore - aScore;
                });
            } else {
                // Default: date
                filteredEvents.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));
            }
        };

        const viewEventDetails = (eventId) => {
            const event = allEvents.find(e => e.id === eventId);
            if (event) {
                alert(`Event: ${event.name}\nDate: ${new Date(event.start_date).toLocaleDateString()}\nTime: ${new Date(event.start_date).toLocaleTimeString()}\nLocation: ${event.party_location_name}\nDescription: ${event.description}\nAttendees: ${event.actual_attendees || 0}\nPrice: ${event.price_tier}`);
            }
        };

        const rsvpToEvent = async (eventId) => {
            try {
                await apiRequest(`/events/${eventId}/rsvp/`, {
                    method: 'POST',
                    body: JSON.stringify({
                        status: 'GOING'
                    })
                });
                showNotification(` RSVP'd to event!`, 'success');
            } catch (error) {
                console.error('Failed to RSVP:', error);
                showNotification('Failed to RSVP to event', 'error');
            }
        };

        // VIDEO FUNCTIONS
        const loadVideos = async () => {
            showLoading(true);
            try {
                const videos = await fetchVideos();
                allVideos = videos;
                
                // Filter user's videos
                myVideos = allVideos.filter(video => video.user === currentUser.userId);
                
                renderVideos();
                showLoading(false);
            } catch (error) {
                console.error('Failed to fetch videos:', error);
                showLoading(false);
            }
        };

        const renderVideos = () => {
            // Render all videos
            allVideosContainer.innerHTML = allVideos.map(video => `
                <div class="bg-gray-800 rounded-lg p-4 shadow-lg cursor-pointer relative" onclick="openVideoFeed(${allVideos.indexOf(video)})">
                    ${video.is_live ? '<div class="live-badge">LIVE</div>' : ''}
                    <div class="bg-gray-700 rounded-lg video-thumbnail flex items-center justify-center">
                        <video src="${video.video_file}" class="w-full h-full object-cover rounded-lg" preload="metadata"></video>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-semibold text-white">${video.username}</h4>
                        <p class="text-gray-300 text-sm mt-1">${video.caption || 'No caption'}</p>
                        <p class="text-gray-500 text-xs mt-2">${new Date(video.timestamp).toLocaleDateString()}  ${video.location_name || 'Unknown Location'}</p>
                    </div>
                </div>
            `).join('');

            // Render user's videos
            myVideosContainer.innerHTML = myVideos.map(video => `
                <div class="bg-gray-700 rounded-lg p-3 flex justify-between items-center">
                    <div>
                        <span class="text-white text-sm block">${video.caption || 'No caption'}</span>
                        <p class="text-gray-400 text-xs mt-1">${new Date(video.timestamp).toLocaleDateString()}  ${video.location_name || 'Unknown Location'}</p>
                    </div>
                    <button class="text-red-400 hover:text-red-300" onclick="deleteUserVideo(${video.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        };

        const handleVideoUpload = async (e) => {
            e.preventDefault();
            const file = videoFile.files[0];
            const caption = videoCaption.value;
            const locationId = videoLocationSelect.value;
            
            if (!file) {
                showNotification("Please select a video file", "error");
                return;
            }
            
            if (!locationId) {
                showNotification("Please select a location", "error");
                return;
            }
            
            if (file.size > 50 * 1024 * 1024) {
                showNotification("Video file too large (max 50MB)", "error");
                return;
            }
            
            const allowedTypes = ["video/mp4", "video/avi", "video/mov", "video/wmv"];
            if (!allowedTypes.includes(file.type)) {
                showNotification("Please select a video file (MP4, AVI, MOV, WMV)", "error");
                return;
            }
            
            showLoading(true);
            
            try {
                const formData = new FormData();
                formData.append('video_file', file);
                formData.append('caption', caption);
                formData.append('party_location', locationId);
                formData.append('is_live', false);
                
                const newVideo = await uploadVideo(formData);
                
                // Add to local state
                allVideos.unshift(newVideo);
                myVideos.unshift(newVideo);
                renderVideos();
                
                // Reset form
                videoFile.value = '';
                videoCaption.value = '';
                videoLocationSelect.value = '';
                
                showNotification("Video uploaded successfully!", "success");
            } catch (error) {
                console.error("Error uploading video:", error);
                showNotification("Failed to upload video", "error");
            } finally {
                showLoading(false);
            }
        };

        const deleteUserVideo = async (videoId) => {
            if (confirm('Are you sure you want to delete this video?')) {
                const success = await deleteVideo(videoId);
                if (success) {
                    allVideos = allVideos.filter(video => video.id !== videoId);
                    myVideos = myVideos.filter(video => video.id !== videoId);
                    renderVideos();
                    showNotification('Video deleted successfully', 'success');
                }
            }
        };

        // CHAT FUNCTIONS
        const connectChat = () => {
            // Close existing connection if any
            if (chatSocket) {
                chatSocket.close();
            }
            
            const token = localStorage.getItem('authToken');
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/chat/${currentChatRoom}/`;
            
            chatSocket = new WebSocket(wsUrl);
            
            chatSocket.onopen = function(e) {
                console.log('WebSocket connection established');
                showNotification('Connected to chat', 'success');
                
                // Add welcome message
                addChatMessage({
                    username: 'System',
                    user_id: 'system'
                }, 'Welcome to Vibez Chat! Start a conversation about parties and events.', false);
            };
            
            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                addChatMessage({
                    username: data.user,
                    user_id: data.user_id
                }, data.message, data.user_id === currentUser.userId);
            };
            
            chatSocket.onclose = function(e) {
                console.log('WebSocket connection closed');
                if (e.code !== 1000) {
                    showNotification('Chat connection lost. Reconnecting...', 'warning');
                    setTimeout(connectChat, 5000);
                }
            };
            
            chatSocket.onerror = function(e) {
                console.error('WebSocket error:', e);
                showNotification('Chat connection error', 'error');
            };
            
            // Update active users list
            updateActiveUsersList();
        };

        const switchChatRoom = (roomName) => {
            currentChatRoom = roomName;
            if (chatSocket) {
                chatSocket.close();
            }
            connectChat();
        };

        const updateActiveUsersList = () => {
            // For demo purposes - in a real app, you'd get this from the server
            const demoUsers = [
                { username: 'PartyLover', user_id: 'user2' },
                { username: 'DanceKing', user_id: 'user3' },
                { username: 'MusicFan', user_id: 'user4' }
            ];
            
            activeUsersList.innerHTML = `
                <li class="flex items-center justify-between p-2 rounded bg-gray-700">
                    <div class="flex items-center">
                        <span class="online-indicator"></span>
                        <span class="text-purple-300">${currentUser.username}</span>
                    </div>
                    <span class="text-xs text-purple-300">You</span>
                </li>
                ${demoUsers.map(user => `
                    <li class="flex items-center p-2 rounded">
                        <span class="online-indicator"></span>
                        <span class="text-gray-300">${user.username}</span>
                    </li>
                `).join('')}
            `;
            
            onlineUsersCount.textContent = `${demoUsers.length + 1} users online`;
        };

        const addChatMessage = (user, message, isOwn = false) => {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${isOwn ? 'own' : 'other'}`;
            
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            messageElement.innerHTML = `
                <p class="text-white">${message}</p>
                <p class="chat-message-time">${user.username}  ${timestamp}</p>
            `;
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        const sendChatMessage = () => {
            if (chatInput.value.trim() && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                const message = {
                    message: chatInput.value.trim(),
                    user_id: currentUser.userId
                };
                
                chatSocket.send(JSON.stringify(message));
                chatInput.value = '';
            }
        };

        // VIDEO FEED FUNCTIONS
        closeFeedButton.addEventListener('click', () => {
            videoFeedContainer.classList.add('hidden');
            // Stop the currently playing video when closing
            const activeVideo = videoFeedList.querySelector('.snap-center video:not([muted])');
            if (activeVideo) activeVideo.pause();
        });
        
        const createVideoCard = (video, index) => {
            const card = document.createElement('div');
            card.className = 'w-full h-screen snap-center relative flex justify-center items-center bg-black';
            
            const videoElement = document.createElement('video');
            videoElement.src = video.video_file; 
            videoElement.className = 'w-full h-full object-cover';
            videoElement.setAttribute('loop', '');
            videoElement.setAttribute('autoplay', '');
            videoElement.setAttribute('playsinline', '');
            videoElement.setAttribute('muted', ''); // Start muted, unmuted when scrolled into view

            // Overlay for information and interaction
            const overlay = `
                <div class="absolute inset-x-0 bottom-0 p-4 text-white bg-gradient-to-t from-black/80 to-transparent">
                    <p class="font-bold text-lg">${video.caption || 'No caption'}</p>
                    <p class="text-sm text-purple-300">${video.username}</p>
                    <p class="text-sm mt-1">@${video.location_name || 'Check-In Location'}</p>
                </div>
                <div class="absolute right-4 bottom-1/4 flex flex-col space-y-6 text-white text-center">
                    <button class="flex flex-col items-center">
                        <span class="text-2xl"></span> <span class="text-xs">Like</span>
                    </button>
                    <button class="flex flex-col items-center">
                        <span class="text-2xl"></span> <span class="text-xs">Comment</span>
                    </button>
                </div>
            `;

            card.appendChild(videoElement);
            card.insertAdjacentHTML('beforeend', overlay);
            return card;
        };

        const renderVideoFeed = (startIndex = 0) => {
            videoFeedList.innerHTML = '';
            videoData.forEach((video, index) => {
                videoFeedList.appendChild(createVideoCard(video, index));
            });

            videoFeedList.removeEventListener('scroll', handleScroll); // Avoid duplicates
            videoFeedList.addEventListener('scroll', handleScroll);
            
            // Initial scroll and play
            const startCard = videoFeedList.querySelector(`.snap-center:nth-child(${startIndex + 1})`);
            if (startCard) {
                 startCard.scrollIntoView({ behavior: 'instant' });
                 const startVideo = startCard.querySelector('video');
                 startVideo.muted = false; // Unmute the starting video
                 startVideo.play().catch(e => console.log('Autoplay failed:', e));
            }
        };

        // This function ensures only the video currently centered in the view is playing and unmuted
        let scrollTimeout;
        const handleScroll = () => {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            
            scrollTimeout = setTimeout(() => {
                const centerPosition = videoFeedList.scrollTop + videoFeedList.clientHeight / 2;

                videoFeedList.querySelectorAll('.snap-center').forEach(card => {
                    const videoElement = card.querySelector('video');
                    const cardTop = card.offsetTop;
                    const cardBottom = card.offsetTop + card.clientHeight;

                    if (centerPosition >= cardTop && centerPosition < cardBottom) {
                        // Currently visible: Play and Unmute
                        videoElement.muted = false;
                        videoElement.play().catch(e => console.log('Play on scroll failed:', e));
                    } else {
                        // Not visible: Pause and Mute
                        videoElement.pause();
                        videoElement.muted = true;
                    }
                });
            }, 150); // Debounce scroll event
        };

        const openVideoFeed = (startingIndex) => {
            videoData = [...allVideos]; // Use all videos for the feed
            if (videoData.length === 0) {
                alert('No videos available.');
                return;
            }
            videoFeedContainer.classList.remove('hidden');
            renderVideoFeed(startingIndex);
        };

        // Start real-time updates
        const startRealTimeUpdates = () => {
            // Clear any existing intervals
            stopRealTimeUpdates();
            
            // Start new intervals only if live updates are enabled
            if (liveUpdatesCheckbox.checked) {
                updateIntervals.map = setInterval(() => {
                    if (document.getElementById('map-content').classList.contains('hidden') === false) {
                        // Only update if user has enabled live updates
                        updateLiveMapData();
                    }
                }, REAL_TIME_CONFIG.MAP_UPDATE_INTERVAL);
                
                updateIntervals.events = setInterval(() => {
                    if (document.getElementById('events-content').classList.contains('hidden') === false) {
                        // Only update if user is on events tab
                        updateLiveEvents();
                    }
                }, REAL_TIME_CONFIG.EVENTS_UPDATE_INTERVAL);
                
                updateIntervals.videos = setInterval(() => {
                    if (document.getElementById('videos-content').classList.contains('hidden') === false) {
                        // Only update if user is on videos tab
                        updateLiveVideos();
                    }
                }, REAL_TIME_CONFIG.VIDEO_UPDATE_INTERVAL);
            }
            
            showNotification('Real-time updates activated', 'success');
        };

        // Stop real-time updates
        const stopRealTimeUpdates = () => {
            Object.values(updateIntervals).forEach(interval => {
                if (interval) clearInterval(interval);
            });
        };

        // Real-time update functions
        const updateLiveMapData = async () => {
            try {
                const updatedLocations = await fetchPartyLocations();
                
                // Update locations that have changed
                updatedLocations.forEach(updatedLocation => {
                    const existingIndex = allLocations.findIndex(loc => loc.id === updatedLocation.id);
                    if (existingIndex !== -1) {
                        allLocations[existingIndex] = updatedLocation;
                    }
                });
                
                // Re-render markers if needed
                addLocationsToMap();
            } catch (error) {
                console.error('Error updating map data:', error);
            }
        };

        const updateLiveEvents = async () => {
            try {
                const updatedEvents = await fetchEvents();
                allEvents = updatedEvents;
                renderEvents();
            } catch (error) {
                console.error('Error updating events:', error);
            }
        };

        const updateLiveVideos = async () => {
            try {
                const updatedVideos = await fetchVideos();
                allVideos = updatedVideos;
                myVideos = allVideos.filter(video => video.user === currentUser.userId);
                renderVideos();
            } catch (error) {
                console.error('Error updating videos:', error);
            }
        };

        // Location services
        const requestLocationPermission = () => {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            timestamp: new Date(),
                            userId: currentUser?.userId,
                            username: currentUser?.username
                        };
                        resolve(userLocation);
                    },
                    (error) => {
                        reject(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // 5 minutes
                    }
                );
            });
        };

        // EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            const username = localStorage.getItem('username');
            const userId = localStorage.getItem('userId');
            
            if (token && username && userId) {
                showMainApp(username, userId);
            } else {
                showLandingPage();
            }
        });

        // Landing page buttons
        getStartedButton.addEventListener('click', showAuthForm);
        joinNowButton.addEventListener('click', showAuthForm);

        // Authentication
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            handleLogin(email, password);
        });

        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            handleRegister(username, email, password);
        });

        toggleButton.addEventListener('click', toggleAuthForm);

        // Dashboard
        logoutButton.addEventListener('click', logout);
        profileButton.addEventListener('click', () => {
            profileModal.classList.remove('hidden');
        });

        // Profile modal
        closeProfileButton.addEventListener('click', () => {
            profileModal.classList.add('hidden');
        });
        cancelProfileButton.addEventListener('click', () => {
            profileModal.classList.add('hidden');
        });
        saveProfileButton.addEventListener('click', handleProfileUpdate);

        // Tab navigation
        mapTab.addEventListener('click', () => showTab('map'));
        eventsTab.addEventListener('click', () => showTab('events'));
        videosTab.addEventListener('click', () => showTab('videos'));
        chatTab.addEventListener('click', () => showTab('chat'));

        // Map filters
        applyFiltersButton.addEventListener('click', applyMapFilters);
        resetFiltersButton.addEventListener('click', resetMapFilters);
        toggleFiltersButton.addEventListener('click', toggleFiltersVisibility);
        if (toggleFilters) {
            toggleFilters.addEventListener('click', toggleFiltersVisibility);
        }

        // Events filters
        eventsSearchBtn.addEventListener('click', renderEvents);
        eventsSearch.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                renderEvents();
            }
        });
        eventsTimeframe.addEventListener('change', renderEvents);
        eventsCategory.addEventListener('change', renderEvents);
        eventsSort.addEventListener('change', renderEvents);

        // Location services
        shareLocationBtn.addEventListener('click', () => {
            locationPermissionModal.classList.remove('hidden');
        });

        allowLocationBtn.addEventListener('click', () => {
            requestLocationPermission()
                .then(location => {
                    userLocation = location;
                    showNotification('Location sharing enabled! Loading real-time data.', 'success');
                    locationPermissionModal.classList.add('hidden');
                    
                    // Center map on user's location
                    if (map) {
                        map.setView([location.lat, location.lng], 14);
                        
                        // Add user location marker
                        const userIcon = L.divIcon({
                            className: 'party-marker user-generated',
                            iconSize: [20, 20],
                            html: '<i class="fas fa-user text-white text-xs flex items-center justify-center h-full"></i>'
                        });
                        
                        L.marker([location.lat, location.lng], { icon: userIcon })
                            .addTo(map)
                            .bindPopup(`
                                <div class="text-white">
                                    <h3 class="font-bold text-lg">Your Location</h3>
                                    <p class="text-sm">You are here!</p>
                                </div>
                            `);
                        
                        // Reload data with user's location
                        loadMapData(location.lat, location.lng);
                    }
                })
                .catch(error => {
                    showNotification('Location access denied. You can still use the app, but location features will be limited.', 'error');
                    locationPermissionModal.classList.add('hidden');
                });
        });

        denyLocationBtn.addEventListener('click', () => {
            locationPermissionModal.classList.add('hidden');
            showNotification('You can enable location sharing later in settings.', 'info');
        });

        checkInBtn.addEventListener('click', () => {
            // Get user's current location for check-in
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Find the closest location
                        let closestLocation = null;
                        let minDistance = Infinity;
                        
                        allLocations.forEach(location => {
                            const distance = Math.sqrt(
                                Math.pow(location.latitude - lat, 2) + 
                                Math.pow(location.longitude - lng, 2)
                            );
                            
                            if (distance < minDistance) {
                                minDistance = distance;
                                closestLocation = location;
                            }
                        });
                        
                        if (closestLocation && minDistance < 0.01) { // Within ~1km
                            checkInToLocationFromMap(closestLocation.id);
                        } else {
                            // Create a new location
                            L.popup()
                                .setLatLng([lat, lng])
                                .setContent(`
                                    <div class="text-white">
                                        <h3 class="font-bold mb-2">Add New Party Spot</h3>
                                        <input type="text" id="new-checkin-location-name" placeholder="Location name" class="w-full p-2 mb-2 rounded bg-gray-700 text-white">
                                        <button onclick="createLocationAt(${lat}, ${lng})" class="w-full py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
                                            Create & Check In
                                        </button>
                                    </div>
                                `)
                                .openOn(map);
                        }
                    },
                    (error) => {
                        showNotification('Unable to get your location. Please enable location services.', 'error');
                    }
                );
            } else {
                showNotification('Geolocation is not supported by your browser', 'error');
            }
        });

        // Video upload
        uploadForm.addEventListener('submit', handleVideoUpload);

        // Chat
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
        sendChatButton.addEventListener('click', sendChatMessage);

        // Live updates checkbox
        liveUpdatesCheckbox.addEventListener('change', () => {
            if (liveUpdatesCheckbox.checked) {
                startRealTimeUpdates();
            } else {
                stopRealTimeUpdates();
                showNotification('Live updates paused', 'info');
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Page is hidden, reduce update frequency
                Object.values(updateIntervals).forEach(interval => {
                    if (interval) clearInterval(interval);
                });
            } else {
                // Page is visible, restart updates if enabled
                if (liveUpdatesCheckbox.checked) {
                    startRealTimeUpdates();
                }
            }
        });
    </script>
</body>
</html>
